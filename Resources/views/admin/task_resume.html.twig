{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    恢复任务 - {{ task.description }}
{% endblock %}

{% block main %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">任务信息</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>任务ID:</strong> {{ task.id }}</p>
                            <p><strong>任务类型:</strong> {{ task.type.value }}</p>
                            <p><strong>任务状态:</strong>
                                <span class="badge badge-warning">
                                    {{ task.status.value }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>当前优先级:</strong> {{ task.priority }}</p>
                            <p><strong>作业位置:</strong> {{ task.location }}</p>
                            <p><strong>分配作业员:</strong>
                                {% if task.assignedWorker %}
                                    作业员 #{{ task.assignedWorker }}
                                {% else %}
                                    <span class="text-muted">未分配</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% if task.description %}
                        <div class="mt-3">
                            <p><strong>任务描述:</strong></p>
                            <p class="text-muted">{{ task.description }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if pause_info %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-pause-circle text-warning"></i>
                            暂停信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>暂停时间:</strong> {{ pause_info.paused_at }}</p>
                                <p><strong>暂停原因:</strong>
                                    {% if pause_info.pause_reason == 'equipment_failure' %}设备故障
                                    {% elseif pause_info.pause_reason == 'material_shortage' %}物料不足
                                    {% elseif pause_info.pause_reason == 'personnel_dispatch' %}人员调度
                                    {% elseif pause_info.pause_reason == 'quality_issue' %}质量问题
                                    {% elseif pause_info.pause_reason == 'urgent_insertion' %}紧急插单
                                    {% elseif pause_info.pause_reason == 'waiting_instruction' %}等待指示
                                    {% else %}其他原因
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>暂停时长:</strong>
                                    {% if pause_info.paused_at %}
                                        {% set now = "now"|date("U") %}
                                        {% set paused = pause_info.paused_at|date("U") %}
                                        {% set duration = (now - paused) %}
                                        {% if duration > 86400 %}
                                            {{ (duration // 86400) }}天 {{ ((duration % 86400) // 3600) }}小时
                                        {% elseif duration > 3600 %}
                                            {{ (duration // 3600) }}小时 {{ ((duration % 3600) // 60) }}分钟
                                        {% else %}
                                            {{ (duration // 60) }}分钟
                                        {% endif %}
                                    {% else %}
                                        未知
                                    {% endif %}
                                </p>
                                <p><strong>操作人:</strong> {{ pause_info.paused_by }}</p>
                            </div>
                        </div>
                        {% if pause_info.pause_description %}
                            <div class="mt-3">
                                <p><strong>详细说明:</strong></p>
                                <p class="text-muted">{{ pause_info.pause_description }}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if resume_check and not resume_check.can_resume %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle"></i>
                            恢复条件检查
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i>
                            <strong>无法恢复任务:</strong> {{ resume_check.reason }}
                        </div>
                        <p class="text-muted">请解决上述问题后再尝试恢复任务。</p>
                        <a href="{{ path('admin') }}" class="btn btn-secondary">返回</a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-play-circle text-success"></i>
                            恢复任务
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if resume_check and resume_check.reason %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>恢复条件已满足:</strong> {{ resume_check.reason }}
                            </div>
                        {% endif %}

                        <div class="alert alert-success">
                            <i class="fas fa-info-circle"></i>
                            <strong>操作说明:</strong> 恢复任务将重新开始任务的执行。系统将自动：
                            <ul class="mt-2 mb-0">
                                <li>将任务状态从"暂停"恢复到之前的状态</li>
                                <li>通知分配的作业员任务已恢复</li>
                                <li>重新分配必要的资源</li>
                            </ul>
                        </div>

                        {{ form_start(form) }}
                        <div class="row">
                            <div class="col-md-8">
                                {{ form_row(form.description) }}
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mt-4">
                                    {{ form_widget(form.resume) }}
                                    <a href="{{ path('admin') }}" class="btn btn-secondary ml-2">取消</a>
                                </div>
                            </div>
                        </div>
                        {{ form_end(form) }}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if task.assignedWorker and resume_check and resume_check.can_resume %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">作业员通知</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-bell"></i>
                            任务恢复后，系统将自动通知分配的作业员（作业员 #{{ task.assignedWorker }}）继续执行任务。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">恢复前的检查清单</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check1">
                                <label class="form-check-label" for="check1">
                                    确认暂停的原因已经解决
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check2">
                                <label class="form-check-label" for="check2">
                                    所需物料和工具已准备就绪
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check3">
                                <label class="form-check-label" for="check3">
                                    相关设备运行正常
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check4">
                                <label class="form-check-label" for="check4">
                                    分配的作业员可以继续工作
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check5">
                                <label class="form-check-label" for="check5">
                                    任务优先级和紧急程度仍然合适
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="check6">
                                <label class="form-check-label" for="check6">
                                    相关人员已通知任务恢复
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-lightbulb"></i>
                        <strong>建议:</strong> 在恢复任务前，请确保以上所有条件都已满足，以避免任务再次暂停。
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}